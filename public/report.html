<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css">
  <title>ë¶„ì„ ë ˆí¬íŠ¸ beta 1.1</title>
</head>

<body>
  <h2>ğŸ™ï¸ ìŒì„± ë¦¬í¬íŠ¸</h2>
  <div class="muted" id="meta"></div>

  <div class="row" id="cards"></div>

  <h3>Stageë³„ ê²°ê³¼</h3>
  <div id="stageTable"></div>

  <button id="goSurveyBtn">ì„¤ë¬¸ ê³„ì†í•˜ê¸°</button>

  <script>
    const API_BASE = "https://rhythme-server-as3ud42lpa-du.a.run.app";

    const fmt = (x, d=2) => (x === null || x === undefined) ? "-" : Number(x).toFixed(d);

    function getSid() {
      const qs = new URLSearchParams(location.search);
      const urlSid = qs.get("sid") || qs.get("session_id");
      const storeSid = localStorage.getItem("SESSION_ID");
      const winSid = window.SESSION_ID;
      const sid = urlSid || storeSid || winSid;

      if (!sid) {
        alert("ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì§„í–‰í•´ì£¼ì„¸ìš”.");
        location.href = "./index.html";
        return null;
      }

      window.SESSION_ID = sid;
      localStorage.setItem("SESSION_ID", sid);
      return sid;
    }

    function qualityLabel(nonOk, snrAvg){
      if (nonOk > 0) return { label: "ì£¼ì˜", note: "ì¼ë¶€ stage í’ˆì§ˆ ì´ìŠˆê°€ ìˆì–´ í•´ì„ ì œí•œì´ ìˆì„ ìˆ˜ ìˆì–´ìš”." };
      if (snrAvg !== null && snrAvg !== undefined && snrAvg < 10) return { label: "ì£¼ì˜", note: "SNRì´ ë‚®ì•„ ì£¼ë³€ ì†ŒìŒ ì˜í–¥ì´ ìˆì„ ìˆ˜ ìˆì–´ìš”." };
      return { label: "ì–‘í˜¸", note: "ë…¹ìŒ í’ˆì§ˆì´ ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸í•´ìš”." };
    }

    function deltas(stages){
      const s1 = stages.find(s => s.stage_id === 1);
      if (!s1) return null;
      return stages.map(s => {
        if (s.stage_id === 1) return { stage_id: 1, d_sr: 0, d_pr: 0, d_psd: 0 };
        return {
          stage_id: s.stage_id,
          d_sr: (s.speech_rate - s1.speech_rate),
          d_pr: (s.pause_ratio - s1.pause_ratio),
          d_psd: (s.pitch_sd - s1.pitch_sd),
        };
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const sid = getSid();
      if (!sid) return;

      const goBtn = document.getElementById("goSurveyBtn");
      if (goBtn) {
        goBtn.addEventListener("click", () => {
          const sid2 = getSid();
          if (!sid2) return;
          location.href = `./survey.html?sid=${encodeURIComponent(sid2)}`;
        });
      }

      const res = await fetch(`${API_BASE}/report/voice?session_id=${encodeURIComponent(sid)}`);
      if (!res.ok) {
        const t = await res.text();
        document.body.innerHTML = `<p>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${res.status}</p><pre>${t}</pre>`;
        return;
      }

      const data = await res.json();
      document.getElementById("meta").textContent = `session_id: ${data.session_id}`;

      const s = data.summary;
      const q = qualityLabel(s.non_ok_count, s.snr_avg);

      document.getElementById("cards").innerHTML = `
        <div class="card">
          <div class="muted">ë°ì´í„° í’ˆì§ˆ</div>
          <div><span class="badge">${q.label}</span></div>
          <div class="muted" style="margin-top:6px;">SNR í‰ê· : ${fmt(s.snr_avg,1)} / non-ok: ${s.non_ok_count}</div>
          <div class="muted">${q.note}</div>
        </div>
        <div class="card">
          <div class="muted">ìš”ì•½(í‰ê· )</div>
          <div>ë§ì†ë„: ${fmt(s.speech_rate_avg,2)}</div>
          <div>ì‰¼ ë¹„ìœ¨: ${fmt(s.pause_ratio_avg,3)}</div>
          <div>ì–µì–‘ ë³€ë™(pitch_sd): ${fmt(s.pitch_sd_avg,1)}</div>
        </div>
        <div class="card">
          <div class="muted">ë²”ìœ„(4 stage)</div>
          <div>ë§ì†ë„: ${fmt(s.speech_rate_min,2)} ~ ${fmt(s.speech_rate_max,2)}</div>
          <div>ì‰¼ ë¹„ìœ¨: ${fmt(s.pause_ratio_min,3)} ~ ${fmt(s.pause_ratio_max,3)}</div>
          <div>pitch_mean: ${fmt(s.pitch_mean_min,1)} ~ ${fmt(s.pitch_mean_max,1)}</div>
        </div>
      `;

      const ds = deltas(data.stages) || [];
      const dMap = new Map(ds.map(x => [x.stage_id, x]));

      const rows = data.stages.map(st => {
        const d = dMap.get(st.stage_id);
        const dSr = d ? fmt(d.d_sr,2) : "-";
        const dPr = d ? fmt(d.d_pr,3) : "-";
        const dPsd = d ? fmt(d.d_psd,1) : "-";
        return `
          <tr>
            <td>${st.stage_id}</td>
            <td>${st.quality_flag}</td>
            <td>${fmt(st.pitch_sd,1)} <span class="muted">(Î” ${dPsd})</span></td>
            <td>${fmt(st.speech_rate,2)} <span class="muted">(Î” ${dSr})</span></td>
            <td>${fmt(st.pause_ratio,3)} <span class="muted">(Î” ${dPr})</span></td>
            <td>${fmt(st.snr,1)}</td>
            <td class="muted">${st.created_at}</td>
          </tr>
        `;
      }).join("");

      document.getElementById("stageTable").innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Stage</th><th>í’ˆì§ˆ</th><th>pitch_sd</th><th>speech_rate</th><th>pause_ratio</th><th>SNR</th><th>timestamp</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        <p class="muted" style="margin-top:8px;">* Î”ëŠ” Stage1(ì½ê¸°) ëŒ€ë¹„ ë³€í™”ëŸ‰</p>
      `;
    });
  </script>
</body>
</html>
