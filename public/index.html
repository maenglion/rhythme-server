<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 기본 -->
<title>CASP Protocol | 나의 음성 체계화 지수</title>
<meta name="description" content="여기를 눌러 테스트 해보세요." />

<!-- Open Graph (카톡/스레드/페북) -->
<meta property="og:type" content="website" />
<meta property="og:title" content="CASP Protocol | 나의 음성 체계화 지수" />
<meta property="og:description" content="여기를 눌러 테스트 해보세요." />
<meta property="og:url" content="https://rhythme-lozee.netlify.app/casp.html" />
<meta property="og:image" content="https://rhythme-lozee.netlify.app/og/casp.png" />

<!-- Twitter (겸사겸사) -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="CASP Protocol | 나의 음성 체계화 지수" />
<meta name="twitter:description" content="여기를 눌러 테스트 해보세요." />
<meta name="twitter:image" content="https://rhythme-lozee.netlify.app/og/casp.png" />

    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>

<section id="step1" class="step active">
    <div class="index-header-monochrome">
        <h1 class="protocol-main-title">CASP Protocol</h1>
        <div class="version-dimmed-sub">v1.1</div>
        <div class="name-sub-group-tight">
            <p class="en-sub-text">Cognitive–Adaptive Stress Paralinguistic Protocol</p>
            <p class="ko-sub-text">인지-적응형 스트레스 발화 테스트</p>
        </div>
    </div>

    <div class="research-info-card-minimal">
        <ul class="spec-list-tight">
            <li><strong>연구 방식:</strong> 40초 발화 데이터 수집 (10~15초 분절 분석)</li>
            <li><strong>핵심 모델:</strong> 파라링귀스틱 특징 × SQ 결합 분포 기반 정규화</li>
            <li><strong>데이터 보호:</strong> 모든 데이터는 익명 세션 ID로 암호화 처리</li>
        </ul>

        <div class="card-divider-monochrome"></div>

        <div class="info-footer-compact">
            <p class="company-name-bold">(주)소울스펙트럼 | SoulSpectrum Inc.</p>
            <p class="pi-name-dimmed">연구 및 개인정보 책임자: 맹난영</p>
        </div>
    </div>
        <div class="button-group" style="margin-top: 40px;">
            <button class="next-btn" onclick="startResearch(false)">14세 이상 연구 참여하기</button>
            <button class="next-btn secondary-btn" style="margin-top: 16px;" onclick="startResearch(true)">
                14세 미만 연구 참여하기 (보호자 동의 필요)
            </button>
        </div>
    </section>

<section id="step2" class="step">
  <h3 class="title">연구 참여 동의</h3>

  <div class="consent-group">
    <div class="consent-item" id="parentalConsentItem" style="display: none;">
      <div class="consent-header" onclick="loadAndToggleConsent('terms-of-use/child.txt', this)">
        <input type="checkbox" class="essential" id="checkParent" onclick="event.stopPropagation()">
        <div class="header-text">
          <span class="subject">법정대리인 동의</span>
          <span class="badge">필수</span>
        </div>
        <span class="arrow">▼</span>
      </div>

      <div class="consent-content">
        <div class="consent-text-area">내용을 불러오는 중...</div>
      </div>
    </div>

    <div class="consent-item">
      <div class="consent-header" onclick="loadAndToggleConsent('terms-of-use/personal.txt', this)">
        <input type="checkbox" class="essential" id="check1" onclick="event.stopPropagation()">
        <div class="header-text">
          <span class="subject">개인정보 수집 및 이용</span>
          <span class="badge">필수</span>
        </div>
        <span class="arrow">▼</span>
      </div>

      <div class="consent-content">
        <div class="consent-text-area">내용을 불러오는 중...</div>
      </div>
    </div>

    <div class="consent-item">
      <div class="consent-header" onclick="loadAndToggleConsent('terms-of-use/voice.txt', this)">
        <input type="checkbox" class="essential" id="check2" onclick="event.stopPropagation()">
        <div class="header-text">
          <span class="subject">음성분석 처리 동의</span>
          <span class="badge">필수</span>
        </div>
        <span class="arrow">▼</span>
      </div>

      <div class="consent-content">
        <div class="consent-text-area">내용을 불러오는 중...</div>
      </div>
    </div>
  </div>

  <div class="consent-item">
  <div class="consent-header" onclick="loadAndToggleConsent('terms-of-use/qeeg.txt', this)">
    <input type="checkbox" id="checkQeeg" onclick="event.stopPropagation()">
    <div class="header-text">
      <span class="subject">qEEG 업로드 및 처리 동의</span>
      <span class="badge select-badge">선택</span> </div>
    <span class="arrow">▼</span>
  </div>

  <div class="consent-content">
    <div class="consent-text-area">내용을 불러오는 중...</div>
  </div>
</div>

  <button class="next-btn" onclick="checkAndGo()">동의 완료 및 다음</button>
</section>



   <section id="step3" class="step">
    <h3 class="title">기본 정보 입력</h3>
    
    <div class="input-group">
        <label class="label">닉네임</label>
        <input type="text" id="nickname" placeholder="익명 가능 (2자 이상)">
    </div>

    <div class="input-group">
        <label class="label">비밀 PIN (4자리)</label>
        <input type="password" id="userPin" maxlength="4" inputmode="numeric" placeholder="숫자 4자리">
        <p class="description" style="font-size: 11px; margin-top: 5px;">* 리포트 조회 및 데이터 삭제 시 반드시 필요합니다.</p>
    </div>

    <div class="input-group last">
        <label class="label">만 나이</label>
        <input type="number" id="age" placeholder="숫자만 입력">
    </div>

    <label class="label">성별</label>
    <div class="gender-group">
        <div class="gender-item">
            <input type="radio" name="gender" id="male" value="male" checked>
            <label for="male" class="gender-label">남성</label>
        </div>
        <div class="gender-item">
            <input type="radio" name="gender" id="female" value="female">
            <label for="female" class="gender-label">여성</label>
        </div>
    </div>
        
    <label class="label">해당하는 진단 정보</label>
    <p class="description">중복 선택이 가능합니다.</p>
    <div class="chip-group">
        <div class="chip" onclick="toggleDiagnosis(this, 'ASD')">ASD</div>
        <div class="chip" onclick="toggleDiagnosis(this, 'ADHD')">ADHD</div>
        <div class="chip" onclick="toggleDiagnosis(this, 'HSP')">HSP</div>
        <div class="chip" onclick="toggleDiagnosis(this, 'None')">해당 없음</div>
    </div>

    <button class="next-btn" style="margin-top: 40px;" onclick="startSQTest()">
  체계화 지수 간이 테스트
</button>
</section>

    <section id="step4" class="step">
        <div id="questionCount" class="step-indicator">1 / 10</div>
        <h3 id="questionText" class="question-title"></h3>
        <div class="answer-group">
<button class="ans-btn" onclick="handleAnswer(1, event)">전혀 아니다</button>
<button class="ans-btn" onclick="handleAnswer(2, event)">아니다</button>
<button class="ans-btn" onclick="handleAnswer(3, event)">보통</button>
<button class="ans-btn" onclick="handleAnswer(4, event)">그렇다</button>
<button class="ans-btn" onclick="handleAnswer(5, event)">매우 그렇다</button>

        </div>
    </section>

<section id="step5" class="step">
    <h3 class="title">qEEG 업로드</h3>
    <p class="description">
        정확한 분석을 위해 EC와 EO 파일을 각각 업로드해 주세요.<br>
        (보조지표이므로 없으셔도 다음 단계 진행이 가능합니다.)
    </p>
    
    <div class="qeeg-unit">
        <label for="qeegEC" class="qeeg-card">
            <div class="qeeg-info">
                <span class="qeeg-tag">EC</span>
                <span class="qeeg-desc">눈 감았을 때</span>
            </div>
            <span id="ecStatus" class="qeeg-filename">미첨부</span>
            <input type="file" id="qeegEC" style="display:none" onchange="updateFileName('EC')">
        </label>
    </div>

    <div class="qeeg-unit">
        <label for="qeegEO" class="qeeg-card">
            <div class="qeeg-info">
                <span class="qeeg-tag">EO</span>
                <span class="qeeg-desc">눈 떴을 때</span>
            </div>
            <span id="eoStatus" class="qeeg-filename">미첨부</span>
            <input type="file" id="qeegEO" style="display:none" onchange="updateFileName('EO')">
        </label>
    </div>

    <button type="button" id="uploadBtn" class="next-btn" onclick="submitAll(event)">다음</button>
</section>

</section>
 <div id="customModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-body"><p id="modalMessage"></p></div>

    <button id="modalCancelBtn" class="modal-btn" style="display:none;">취소</button>
    <button id="modalOkBtn" class="modal-btn">확인</button>
  </div>
</div>

<div id="chrome-modal" onclick="closeModal(event)" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; display:flex; justify-content:center; align-items:center;">
    <div style="background:#222; color:#fff; padding:25px; border-radius:15px; text-align:center; width:320px; border:1px solid #444; position:relative;" onclick="event.stopPropagation()">
        
        <span onclick="document.getElementById('chrome-modal').style.display='none'" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:20px; color:#888;">&times;</span>

        <h3 style="margin-top:10px; font-size:18px;">최적의 환경 안내</h3>
        <p style="font-size:14px; color:#ccc; line-height:1.5;">
            <b>구글 크롬(Chrome)</b>에서 접속하시면<br>분석이 더욱 정확하고 빠릅니다.
        </p>
        
        <button id="btn-intent" style="display:none; background:#4285F4; color:white; border:none; padding:14px; border-radius:8px; font-weight:bold; cursor:pointer; width:100%; margin-bottom:10px; font-size:15px;">
            크롬 앱으로 즉시 이동
        </button>
        
        <button onclick="copyCurrentUrl()" style="background:#444; color:white; border:none; padding:14px; border-radius:8px; font-weight:bold; cursor:pointer; width:100%; font-size:15px;">
            주소 복사 후 크롬 실행
        </button>
    </div>
</div>
<script>
// 1. 모달 닫기 기능 (공통 사용)
window.closeModal = function () {
    const modal = document.getElementById('chrome-modal') || document.getElementById('customModal');
    if (modal) modal.style.display = 'none';
};

// 2. 크롬 유도 및 자동 전환 로직
(function() {
    const ua = navigator.userAgent.toLowerCase();
    const isChrome = /chrome/.test(ua) && !/edge|opr|brave/.test(ua);
    const isKakao = /kakaotalk/i.test(ua);
    const isAndroid = /android/.test(ua);

    // 환경 체크 (크롬도 아니고 카톡도 아닐 때)
    if (!isChrome && !isKakao) {
        window.addEventListener('load', function() {
            const modal = document.getElementById('chrome-modal');
            if (modal) {
                modal.style.display = 'flex';
                
                if (isAndroid) {
                    const url = window.location.href.replace(/https?:\/\//, '');
                    const intentUrl = `intent://${url}#Intent;scheme=https;package=com.android.chrome;end`;
                    
                    // 안드로이드는 0.5초 뒤 자동 전환 시도
                    setTimeout(() => { location.href = intentUrl; }, 500);
                }
            }
        });
    }
})();

// 3. URL 복사 기능
function copyCurrentUrl() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        alert('주소가 복사되었습니다.');
    }).catch(() => {
        const dummy = document.createElement('input');
        document.body.appendChild(dummy);
        dummy.value = url;
        dummy.select();
        document.execCommand('copy');
        document.body.removeChild(dummy);
        alert('주소가 복사되었습니다.');
    });
}

</script>
<script src="./runtime-config.js?v=1"></script>
<script src="./session-guard.js"></script>
<script src="./report.js"></script>
<script type="module" src="app.js"></script>


</body>
</html>