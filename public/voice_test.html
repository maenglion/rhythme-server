<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css">
    <title>음성 분석</title>
</head>
<script type="module">
  import { VoiceProcessor } from "./voice-processor.js?v=2";
  import { setQuestionText, setDescriptionText, setTimer, setRecordButtonState } from "./voice-ui.js";

  // ---------------------------
  // API helper
  // ---------------------------
  function apiUrl(path) {
    const base = localStorage.getItem("API_BASE") || "";
    return base ? base.replace(/\/$/, "") + path : path;
  }

  // ---------------------------
  // Session helper (단일 진실)
  // ---------------------------
function getSid() {
  const urlSid = new URLSearchParams(location.search).get("sid");
  const storeSid = localStorage.getItem("SESSION_ID");
  const winSid = window.SESSION_ID;

  const sid = urlSid || storeSid || winSid;

  if (!sid) {
    if (typeof window.showModal === "function") {
      window.showModal("세션이 없습니다. 처음부터 다시 진행해주세요.");
      setTimeout(() => location.href = "./index.html", 300);
    } else {
      alert("세션이 없습니다. 처음부터 다시 진행해주세요.");
      location.href = "./index.html";
    }
    return null;
  }

  window.SESSION_ID = sid;
  localStorage.setItem("SESSION_ID", sid);
  return sid;
}


  // ---------------------------
  // Progress (테스트 이어하기/초기화)
  // ---------------------------
  const ALLOW_RESUME = false;          // 운영모드: false 추천(항상 처음부터)
  const MAX_IDLE_MS = 15 * 60 * 1000;  // resume 허용 시, 15분 이상 비면 새로

  function progressKey(sid) { return `rh_progress_${sid}`; }
  function idleKey(sid) { return `rh_last_${sid}`; }

  function loadProgress(sid) {
    try { return JSON.parse(localStorage.getItem(progressKey(sid)) || "null"); }
    catch { return null; }
  }
  function saveProgress(sid, data) {
    localStorage.setItem(progressKey(sid), JSON.stringify(data));
    localStorage.setItem(idleKey(sid), String(Date.now()));
  }
  function clearProgress(sid) {
    localStorage.removeItem(progressKey(sid));
    localStorage.removeItem(idleKey(sid));
  }

  function startNewRun() {
    const oldSid = localStorage.getItem("SESSION_ID");
    if (oldSid) clearProgress(oldSid);

    const sid = (crypto?.randomUUID)
      ? crypto.randomUUID()
      : `sid_${Date.now()}_${Math.random().toString(16).slice(2)}`;

    localStorage.setItem("SESSION_ID", sid);
    window.SESSION_ID = sid;

    stageIdx = 0;
    saveProgress(sid, { stageIdx: 0, startedAt: Date.now() });
    return sid;
  }

  function bootstrapRun() {
    const sid = getSid();
    const last = Number(localStorage.getItem(idleKey(sid)) || "0");
    const idle = Date.now() - last;
    const p = loadProgress(sid);

    if (!ALLOW_RESUME) {
      return startNewRun();
    }

    if (!p || idle > MAX_IDLE_MS) {
      return startNewRun();
    }

    stageIdx = p.stageIdx ?? 0;
    localStorage.setItem(idleKey(sid), String(Date.now()));
    return sid;
  }

  // ---------------------------
  // Stage 설계
  // ---------------------------
  function getStagesByAge(age) {
    const isUnder14 = age < 14;

    const STAGE1_TEXT = `지금 나는 내 음성에 귀를 기울인다. 글을 소리 내어 읽을 때는 세 가지를 지킨다.
첫째, 쉼표에서는 잠깐 쉰다. 
둘째, 마침표에서는 숨을 고른다. 
셋째, 눈은 글을 따라 천천히 내려간다.

매일 저녁 나는 오늘 있었던 일들을 체크한다.
그 과정을 통해 숫자, 친숙한 단어, 가끔은 낯선 단어들이 나의 하루에 녹아있다.

09:30, 12:10, 18:45
기준, 예외, 패턴, 규칙
기쁨, 아쉬움, 안도
왜곡, 의외성, 잡념

급하게 말하지 않고, 틀려도 괜찮다.
틀린 곳 부터 다시 이어서 읽는다. 
끝까지 읽고 시간이 남으면 처음부터 다시 읽는다.`;

    const STAGE4_Q = "노력을 해도 해결이 되지 않는다면 보통 어떻게 하나요?";

    const baseStages = [
      { id: 1, q: "Stage 1", d: "위 지문을 편안하게 소리 내어 읽어주세요. 끝까지 읽지 않아도 됩니다. (Baseline 측정)", text: STAGE1_TEXT },
      { id: 4, q: "Stage 4", d: "", text: STAGE4_Q }
    ];

    if (isUnder14) {
      return [
        baseStages[0],
        { id: 2, q: "Stage 2", d: "게임/취미/코딩/학교 등 무엇을 파고 있고 왜 궁금한지 말해 주세요.", text: "최근 2년 안에 내가 계속 파고 있는 주제가 있다면 말해 주세요." },
        { id: 3, q: "Stage 3", d: "아직 진행 중이어도 괜찮아요.", text: "내 관심주제를 더 많이 알거나 고민을 해결하려고 내가 해본 게 있나요?" },
        baseStages[1]
      ];
    }

    return [
      baseStages[0],
      { id: 2, q: "Stage 2", d: "원인 → 해결방법 → 결과 순서로 짧게 설명해 주세요.", text: "내가 발견한 문제 중 해결을 위해 노력한 것이 있다면 설명해 주세요." },
      { id: 3, q: "Stage 3", d: "", text: "진행 중이라면 막히는 지점을, 완료했다면 어려웠던 지점을 설명해주세요." },
      baseStages[1]
    ];
  }

  // ---------------------------
  // 상태
  // ---------------------------
  const vp = new VoiceProcessor();
  let stageIdx = 0;
  let STAGES = [];

  // DEV DEBUG (콘솔 확인용)
  window.__rh = {
    get stageIdx() { return stageIdx; },
    get STAGES() { return STAGES; },
    get currStage() { return STAGES?.[stageIdx]; },
    vp,
    VoiceProcessor,
    getSid,
    apiUrl,
  };
  console.log("[DBG] __rh ready", window.__rh);

  // ---------------------------
  // 렌더
  // ---------------------------
  function renderStage() {
    const s = STAGES[stageIdx];

    if (!s) {
      const sid = getSid();
      location.href = sid ? `./done.html?sid=${encodeURIComponent(sid)}` : "./done.html";
      return;
    }

    const badge = document.getElementById("stageBadge");
    if (badge) badge.innerText = `Stage ${s.id}`;

    setQuestionText(s.text || s.q);
    setDescriptionText(s.d || "");

    setTimer(40000);
    setRecordButtonState({ recording: false, calibrating: false });

    const finishBtn = document.getElementById("finishBtn");
    if (finishBtn) finishBtn.style.display = "none";

    const recBtn = document.querySelector("#recordBtn");
    if (recBtn) recBtn.dataset.recording = "0";
  }

  // ---------------------------
  // 녹음 + 전송
  // ---------------------------
  async function runVoiceStage() {
    const recBtn = document.querySelector("#recordBtn");
    const finishBtn = document.getElementById("finishBtn");

    try {
      const s = STAGES[stageIdx];
      if (!s) return;
const sid = getSid();
if (!sid) return;

      const age = parseInt(localStorage.getItem("rhythmi_age") || "0", 10);
      const age_group = age < 14 ? "under14" : (age < 19 ? "child" : "adult");

      // 1) 캘리브레이션
      setRecordButtonState({ recording: false, calibrating: true });
      await vp.calibrateSilence(2);

      // 2) 녹음 시작 UI
      setRecordButtonState({ recording: true, calibrating: false });
      if (recBtn) recBtn.dataset.recording = "1";

      // 3) 조기 종료 버튼
      if (finishBtn) {
        finishBtn.style.display = "inline-block";
        finishBtn.onclick = () => {
          if (typeof vp.stop === "function") vp.stop();
          else vp._stopped = true; // stop() 없을 때도 최소한 멈추게
          finishBtn.style.display = "none";
        };
      }

      // 4) 녹음
      const metrics = await vp.startStage({
        durationSec: 40,
        onTick: ({ leftMs }) => setTimer(leftMs, 40)
      });

      console.log("Stage Metrics:", metrics);

      // 5) 서버 전송
      const payload = {
        session_id: sid,
        stage_id: s.id,
        age_group,
        status: metrics.status,

        recorded_ms: metrics.recorded_ms,
        speech_rate: metrics.speech_rate,
        pause_ratio: metrics.pause_ratio,
        pitch_mean: metrics.pitch_mean,
        pitch_sd: metrics.pitch_sd,
        snr_est_db: metrics.snr_est_db,
        clipping_ratio: metrics.clipping_ratio,

        long_pause_count_600ms: metrics.long_pause_count_600ms,
        short_pause_count_200_600ms: metrics.short_pause_count_200_600ms,
        pause_ms: metrics.pause_ms,
        restart_rms_spike_count: metrics.restart_rms_spike_count,

        // 서버 필수 필드(임시값)
        start_latency_ms: 0,
        stop_offset_ms: metrics.recorded_ms ?? 40000,
        jitter: 0,
        shimmer: 0,
      };

      const url = apiUrl("/submit-voice-stage");
      console.log("SUBMIT 직전", url, payload);

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const bodyText = await res.text();
      console.log("SUBMIT 응답", res.status, bodyText);

      if (!res.ok) {
        throw new Error(`submit failed ${res.status}: ${bodyText}`);
      }

      // ✅ POST 성공 직후 진행상태 저장
      saveProgress(sid, {
        stageIdx: stageIdx + 1,
        startedAt: loadProgress(sid)?.startedAt ?? Date.now()
      });

      // 6) 다음 stage
      stageIdx += 1;
      renderStage();

    } catch (err) {
      console.error("오류:", err);
      alert("녹음/전송 중 오류가 발생했습니다. 콘솔 로그를 확인해주세요.");

      setRecordButtonState({ recording: false, calibrating: false });
      const recBtn2 = document.querySelector("#recordBtn");
      if (recBtn2) recBtn2.dataset.recording = "0";
    }
  }

  // ---------------------------
  // 초기화
  // ---------------------------
  document.addEventListener("DOMContentLoaded", () => {
    const age = parseInt(localStorage.getItem("rhythmi_age") || "20", 10);
    STAGES = getStagesByAge(age);

    bootstrapRun(); // stageIdx/SESSION_ID 정리
    renderStage();

    const recBtn = document.querySelector("#recordBtn");
    if (recBtn) {
      recBtn.addEventListener("click", () => {
        if (recBtn.dataset.recording !== "1") runVoiceStage();
      });
    }
  });
</script>

<body>
    <div class="container">
        <div class="progress-container">
            <div class="progress-bar" style="width: 95%;"></div>
        </div>

        <div id="stageWrap" style="text-align: center;">
            <div id="stageBadge" class="badge" style="margin-bottom: 20px; display: inline-block;">Stage 1</div>
            <p id="desc" class="description">제시된 지문을 또박또박 읽어주세요.</p>
            <h2 id="question" class="question-title" style="text-align: center; margin-bottom: 30px;">지문 로딩 중...</h2>

         <div class="recorder-wrapper" style="position: relative; width: 200px; height: 260px; margin: 0 auto; display: flex; flex-direction: column; align-items: center;">
    
    <div style="position: relative; width: 180px; height: 180px; display: flex; align-items: center; justify-content: center;">
        <svg width="180" height="180" style="transform: rotate(-90deg); position: absolute;">
            <circle cx="90" cy="90" r="80" stroke="#333" stroke-width="4" fill="none"></circle>
            <circle id="timerLine" cx="90" cy="90" r="80" stroke="#BB86FC" stroke-width="4" fill="none" stroke-dasharray="502" stroke-dashoffset="0"></circle>
        </svg>
        <div id="timer" style="font-size: 32px; color: #BB86FC; font-weight: bold; z-index: 10;">40s</div>
    </div>
    
    <div style="width: 40px; height: 1px; background: rgba(187, 134, 252, 0.4); margin: 15px 0;"></div>

   <button id="recordBtn" style="background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; padding: 0;">
        <div id="recordCircle" style="width: 16px; height: 16px; background: #d24a4a; border-radius: 50%; margin-bottom: 8px;"></div>
        <span id="recordStatus" style="font-size: 16px; font-weight: 900; color: #fff;">녹음 시작</span>
    </button>

    <span id="calibratingText" style="margin-top: 10px; font-size: 13px; color: rgba(187, 134, 252, 0.5); visibility: hidden;">소음 측정 중...</span>
</div>

<div style="margin-top: 40px;">
    </div>

    </body>
</html>
