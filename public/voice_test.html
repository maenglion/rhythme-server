<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>음성 분석</title>
</head>
<body>
  <div id="stageWrap">
    <div id="stageBadge"></div>
    <div id="desc"></div>
    <pre id="question" style="white-space:pre-wrap;"></pre>

    <!-- 타이머 UI (네 기존 SVG 그대로 가져와도 됨) -->
    <div id="timer">40s</div>
    <svg width="120" height="120">
      <circle id="timerLine" cx="60" cy="60" r="45" stroke="purple" stroke-width="4" fill="none"
        stroke-dasharray="283" stroke-dashoffset="0"></circle>
    </svg>

    <button id="recordBtn"><span id="recordIcon"></span> 녹음 시작</button>
    <button id="finishBtn" type="button">다 말했어요</button>
  </div>

  <!-- ✅ ESM: voice-ui.js가 export 쓰고 있으니 꼭 module로 -->
  <script type="module">
    import { initStageUI, setTimer, setRecordButtonState } from './js/voice-ui.js';
    import { VoiceProcessor } from './js/voice-processor.js';

    const vp = new VoiceProcessor();

    // Stage 1 화면 세팅: ✅ voice-ui.js의 원문 지문이 그대로 들어감
    document.getElementById('stageBadge').innerText = 'Stage 1';
    initStageUI(1);

    // 버튼 동작(일단 “오류 안나게” 최소만)
    const recBtn = document.getElementById('recordBtn');
    const finishBtn = document.getElementById('finishBtn');

    let recording = false;

    recBtn.addEventListener('click', async () => {
      if (!recording) {
        recording = true;
        setRecordButtonState({ recording: false, calibrating: true });
        await vp.calibrateSilence(2);

        setRecordButtonState({ recording: true, calibrating: false });

        // 타이머 표시
        const metrics = await vp.startStage({
          durationSec: 40,
          onTick: ({ leftMs }) => setTimer(leftMs, 40),
        });

        // 여기서 다음 단계/전송은 다음 단계에서 붙이면 됨(오늘은 UI부터)
        recording = false;
        setRecordButtonState({ recording: false });
        console.log('metrics:', metrics);
      } else {
        vp.stop();
      }
    });

    finishBtn.addEventListener('click', () => {
      vp.stop(); // “다 말했어요”는 stop만 호출 (중복 처리/저장 로직은 다음 단계에서)
      finishBtn.disabled = true;
      finishBtn.innerText = '저장 중...';
    });
  </script>
</body>
</html>

